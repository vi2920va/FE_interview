# FrontEnd - 브라우저 작동원리

## 설명

기본적으로 브라우저는 사용자가 참조하고자 하는 웹페이지를 서버에 요청(Request)하고 서버의 응답(Response)을 받아 브라우저에 표시하는 것입니다.

### 1. 브라우저 기본 구조

- 사용자 인터페이스 -> 브라우저 엔진 -> 렌더링 엔진 -> 통신, 자바스크립트 해석기, UI 백엔드
사용자 인터페이스와 렌더링 엔진 사이의 동작을 브라우저 엔진이 제어하게됩니다. 그리고 렌더링 엔진에서 요청한 콘텐츠를 화면에 표시하게됩니다.

### 2. 파싱

- 파싱은 프로그래밍 언어의 문법에 맞게 작성된 텍스트 문서를 읽어 들여 실행하기 위해 텍스트 문서의 문자열을 토큰으로 분해하고 토큰의 문법적 의미와 구조를 반영하여 트리 구조의 자료구조인 파스 트리를 생성하는 일련의 과정을 말합니다. 일반적으로 파싱이 완료된 이후에는 파스 트리를 기반으로 중간 언어인 바이트코드를 생성하고 실행합니다.

### 3. 렌더링

- 렌더링은 HTML, CSS, 자바스크립트로 작성된 문서를 파싱하여 브라우저에 시각적으로 출력하는 것을 말합니다.

### 4. 브라우저 렌더링 과정

1. 서버에서 HTML,CSS등 웹 사이트에 필요한 리소스를 다운받습니다.
2. HTML을 파싱하여 DOM Tree를 생성합니다. 마찬가지로 CSS를 파싱하여 CSSOM Tree를 생성합니다.
3. DOM Tree와 CSSOM Tree를 합친 Render Tree를 생성합니다. 렌더트리는 실제 화면에 표현되는 노드들로만 구성됩니다.
   참고로 display:none 속성같은 경우는 화면에 어떠한 공간도 차지하지 않기 때문에 렌더트리에서 제외됩니다.
4. Layout에서는 뷰포트 내에서 각 노드들의 위치와 크기를 계산합니다. 이때 퍼센트,vh,vw와 같은 상대적인 측정값은 화면에서 절대적인 픽셀단위로 변환됩니다.
5. 마지막으로 요소들을 실제 화면에 그리게 됩니다.이 단계를 페인팅 단계라고 합니다.

위 과정이 다 끝난 뒤 이벤트에따라 새로운 HTML 요소가 추가되거나, 기존 태그들의 스타일이 변경되면 렌더트리와 각 요소들의 크기와 위치를 다시 계산하게됩니다. 이러한 과정을 Reflow라고 합니다.

리플로우단계는 변경사항을 반영하기위해 렌더트리를 다시 생성하고 Layout과정을 다시 수행하는 것이고 실제 화면에 그리기위해서는 다시 페인팅 단계를 수행해야됩니다.

이러한 과정을 **RePaint** 라고 합니다. 항상 리플로우 -> 리페인트 단계를 거치는게 아니고 레이아웃에 영향을 미치지않는 background-color 변경 같은 경우는 바로 리페인트만 수행하게 됩니다.

### 5. HTML 파싱과 DOM 생성

- 브라우저의 요청에 의해 서버가 응답한 HTML 문서는 문자열로 이루어진 순수한 텍스트 입니다.
- 순수한 텍스트인 HTML 문서를 브라우저에 시각적인 픽셀로 렌더링하려면 HTML 문서를 브라우저가 이해할 수 있는 자료구조로 변환하여 메모리에 저장하여야 합니다.
- 브라우저의 렌더링 엔진은 응답받은 HTML 문서를 파싱하여 브라우저가 이해할 수 있는 자료구조인 DOM을 생성합니다.

### 6. CSS 파싱과 CSSOM 생성

- 렌더링 엔진이 DOM을 생성해 나가다가 CSS를 로드하는 link 태그나 style 태그를 만나면 DOM 생성을 일시 중단합니다.
- link 태그의 href 어트리뷰트에 지정된 CSS 파일을 서버에 요청하여 로드한 CSS파일이나 style 태그 내의 CSS를 HTML과 동일한 파싱 과정(바이트->문자->토큰->노드->CSSOM)을 거치며 해석하여 CSSOM을 생성합니다.
- 이후 CSS 파싱을 완료하면 HTML 파싱이 중단된 지점부터 다시 HTML을 파싱하기 시작하여 DOM 생성을 재개합니다.

### 7. 렌더 트리 생성

- 렌더링 엔진은 서버로부터 응답된 HTML과 CSS를 파싱하여 각각 HTML과 CSSOM을 생성합니다.
- DOM과 CSSOM은 렌더링을 위해 렌더 트리로 결합됩니다.
- 렌더 트리는 브라우저 화면에 렌더링되지 않는 노드(예: meta 태그, script 태그 등)와 CSS에 의해 비표시(예: display: none)되는 노드들은 포함하지 않습니다.
- 렌더 트리는 브라우저 화면에 렌더링되는 노드로만 구성됩니다.
- 이후 완성된 렌더 트리는 각 HTML 요소의 레이아웃(위치와 크기)을 계산하는 데 사용되며 브라우저 화면에 픽셀을 렌더링하는 페인팅 처리에 입력됩니다.
- 레이아웃 계산과 페인팅을 다시 실행하는 리렌더링은 비용이 많이 드는 악영향을 주는 작업이므로 리렌더링이 빈번하게 발생하지 않도록 주의할 필요가 있습니다.

### 8. 자바스크립트 파싱

- 렌더링 엔진은 DOM을 생성해 나가다 script 태그를 만나면 DOM 생성을 일시 중단합니다.
- script 태그의 src 어트리뷰트에 정의된 자바스크립트 파일을 서버에 요청하여 로드한 자바스크립트 파일이나 script 태그 내의 자바스크립트 코드를 파싱하기 위해 자바스크립트 엔진에 제어권을 넘깁니다.
- 자바스크립트 파싱과 실행은 브라우저의 렌더링 엔진이 아닌 자바스크립트 엔진이 처리합니다.
- 자바스크립트 엔진은 자바스크립트 코드를 파싱하여 CPU가 이해할 수 있는 저수준 언어로 변환하고 실행하는 역할을 합니다.
- 자바스크립트 엔진은 자바스크립트를 해석하여 AST(추상적 구문 트리)를 생성합니다.
- AST를 기반으로 인터프리터가 실행할 수 있는 중간 코드인 바이트코드를 생성하여 실행합니다.

## 요약

- 사용자 인터페이스와 렌더링 엔진 사이의 동작을 브라우저 엔진이 제어하게되며 렌더링 엔진에서 요청한 콘텐츠를 화면에 표시하게됩니다.
- 브라우저 렌더링 과정은 서버에서 받은 HTML,CSS 파싱 -> DOM,CSSOM Tree생성 -> Render Tree생성 -> Layout -> Paint 순서로 진행됩니다.
- DOM은 HTML 문서를 파싱한 결과물입니다.
- 렌더링 엔진은 HTML과 동일한 해석 과정을 거쳐 CSS를 파싱하여 CSSOM을 생성합니다.
- 자바스크립트 엔진은 자바스크립트 코드를 파싱하여 CPU가 이해할 수 있는 저수준 언어로 변환하고 실행하는 역할을 합니다.

## 참고

- [브라우저 동작원리](https://poiemaweb.com/js-browser)
- [브라우저는 어떻게 동작하는가?](https://d2.naver.com/helloworld/59361)
